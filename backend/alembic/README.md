# Database Migrations with Alembic

This directory contains Alembic database migrations for BuiltEnvironment.ai.

## Overview

Alembic is configured to work with async SQLAlchemy and PostgreSQL with TimescaleDB extension.

## Common Commands

### Inside Docker Container

```bash
# Access the backend container
docker exec -it builtenvironment-backend bash

# Generate a new migration (autogenerate from models)
alembic revision --autogenerate -m "description of changes"

# Apply migrations (upgrade to latest)
alembic upgrade head

# Downgrade one version
alembic downgrade -1

# Show current revision
alembic current

# Show migration history
alembic history --verbose

# Downgrade to a specific revision
alembic downgrade <revision_id>
```

### During Development

```bash
# Create new migration after model changes
docker exec builtenvironment-backend alembic revision --autogenerate -m "add new field to user model"

# Apply migrations
docker exec builtenvironment-backend alembic upgrade head

# Check current state
docker exec builtenvironment-backend alembic current
```

## Migration Workflow

1. **Make Model Changes**: Edit files in `app/models/`
2. **Generate Migration**: `alembic revision --autogenerate -m "describe change"`
3. **Review Migration**: Check the generated file in `alembic/versions/`
4. **Edit if Needed**: Alembic doesn't catch everything (indexes, constraints)
5. **Test Migration**: `alembic upgrade head`
6. **Test Rollback**: `alembic downgrade -1`
7. **Commit**: Add migration file to git

## Initial Migration

The initial migration creates all tables:
- `tenants` - Multi-tenant organizations
- `users` - User accounts with tenant association
- `subscriptions` - Stripe subscription management
- `projects` - Building projects
- `documents` - Uploaded documents with AI analysis
- `audit_events` - Comprehensive activity tracking

## Important Notes

### TimescaleDB Extension

The database uses TimescaleDB extension for efficient time-series data in `audit_events`. This is initialized in `backend/scripts/init-db.sql`.

### Async Support

Alembic is configured for async SQLAlchemy:
- Uses `async_engine_from_config` in `env.py`
- Runs migrations with `asyncio.run()`
- Compatible with `asyncpg` driver

### Multi-Tenancy

All models (except Tenant itself) have a `tenant_id` foreign key for data isolation.

### JSONB Fields

Several models use JSONB for flexible data:
- `compliance_summary` in Projects
- `ai_analysis` in Documents
- `compliance_findings` in Documents
- `ai_metadata` in AuditEvents

### Enums

Models use PostgreSQL enums:
- `SubscriptionStatus`
- `SubscriptionTier`
- `ProjectStatus`
- `DocumentType`
- `DocumentStatus`
- `EventType`

## Production Migrations

### Dokploy Deployment

Migrations run automatically on deployment via the Dockerfile CMD:

```bash
# In production Dockerfile
CMD alembic upgrade head && \
    gunicorn app.main:app --workers 4 --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
```

### Manual Production Migration

If you need to run migrations manually in production:

```bash
# SSH into Dokploy server
ssh user@your-server

# Access the container
docker exec -it <container_name> bash

# Run migrations
alembic upgrade head
```

## Troubleshooting

### "Target database is not up to date"

```bash
# Check current version
alembic current

# Check available migrations
alembic history

# Upgrade to latest
alembic upgrade head
```

### Migration Conflicts

If you have multiple branches with migrations:

```bash
# Merge branches with alembic
alembic merge heads -m "merge branches"
```

### Reset Database (Development Only)

```bash
# Drop all tables and rerun migrations
docker-compose down -v
docker-compose up -d postgres
sleep 10
docker exec builtenvironment-backend alembic upgrade head
```

## Best Practices

1. **Always Review Autogenerated Migrations**: Alembic doesn't catch everything
2. **Test Both Up and Down**: Make sure rollback works
3. **One Migration Per Feature**: Keep migrations focused
4. **Add Data Migrations Carefully**: Use `op.execute()` for data changes
5. **Version Control**: Always commit migration files
6. **Production Testing**: Test migrations on staging before production

## File Structure

```
alembic/
├── README.md           # This file
├── env.py             # Alembic environment configuration (async support)
├── script.py.mako     # Template for new migration files
└── versions/          # Generated migration files
    └── YYYYMMDD_HHMM_<revision>_<slug>.py
```
